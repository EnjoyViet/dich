<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‹¤êµ­ì–´ AI í†µì—­ê¸° (3ê°œ ì–¸ì–´)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* ë°°ê²½ìƒ‰ì„ ì‚´ì§ íšŒìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }
        /* ë§ˆì´í¬/ë‹¤ì‹œë“£ê¸° ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ë§ */
        .mic-btn, .replay-btn {
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
        }
        .mic-btn:hover:not(:disabled), .replay-btn:hover:not(:disabled) {
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.3), 0 4px 6px -4px rgba(59, 130, 246, 0.3);
            transform: translateY(-2px);
        }
        .mic-btn:disabled, .replay-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        /* ë…¹ìŒ ì¤‘ ìŠ¤íƒ€ì¼ (Mic only) */
        .listening {
            animation: pulse-ring 1s infinite;
        }
        @keyframes pulse-ring {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
    </style>
</head>
<body class="min-h-screen flex items-start justify-center p-0">

    <!-- í†µì—­ ì„¸ì…˜ ì˜ì—­ -->
    <div class="w-full h-screen bg-white p-4 md:p-6 overflow-y-auto max-w-lg shadow-lg"> 
        <h1 class="text-2xl font-extrabold text-gray-800 mb-6 text-center">ë‹¤êµ­ì–´ ì‹¤ì‹œê°„ í†µì—­</h1>

        <!-- ì–¸ì–´ ì„ íƒ ì˜ì—­ -->
        <div class="flex space-x-4 mb-6 p-4 bg-gray-100 rounded-xl border border-gray-200">
            <!-- My Language Selector (L1) -->
            <div class="flex-1">
                <label for="selectL1" class="block text-sm font-medium text-gray-700">ë‚˜ì˜ ì–¸ì–´ (My Language)</label>
                <select id="selectL1" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white">
                    <option value="ko-KR">í•œêµ­ì–´ (Korean)</option>
                    <option value="en-US">ì˜ì–´ (English)</option>
                    <option value="vi-VN">ë² íŠ¸ë‚¨ì–´ (Vietnamese)</option>
                </select>
            </div>
            <!-- Their Language Selector (L2) -->
            <div class="flex-1">
                <label for="selectL2" class="block text-sm font-medium text-gray-700">ìƒëŒ€ë°© ì–¸ì–´ (Their Language)</label>
                <select id="selectL2" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md bg-white">
                    <option value="vi-VN">ë² íŠ¸ë‚¨ì–´ (Vietnamese)</option>
                    <option value="en-US">ì˜ì–´ (English)</option>
                    <option value="ko-KR">í•œêµ­ì–´ (Korean)</option>
                </select>
            </div>
        </div>

        <!-- ë‚˜ì˜ ì–¸ì–´ (My Language) ì„¹ì…˜: L1 -->
        <div id="sectionL1" class="bg-blue-50 border-2 border-blue-200 rounded-xl p-4 mb-6">
            <div class="flex justify-between items-center mb-4">
                <h2 id="titleL1" class="text-xl font-bold text-blue-700"></h2>
                <span id="speakerL1" class="text-sm text-blue-500 font-semibold"></span>
            </div>
            <div id="outputL1" class="min-h-[6rem] p-3 bg-white rounded-lg border border-blue-200 text-gray-700 break-words text-base">
                ë²ˆì—­ëœ ìƒëŒ€ë°© ì–¸ì–´ ìŒì„± ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
            <div class="flex justify-center mt-4 space-x-4">
                <!-- ë§ˆì´í¬ ë²„íŠ¼ -->
                <button id="micL1" onclick="startRecognition('L1')"
                        class="mic-btn bg-blue-500 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center disabled:bg-gray-400">
                    <!-- Mic Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M128,176a48,48,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48,48,0,0,0,128,176ZM184,128a56,56,0,0,1-112,0V64a56,56,0,0,1,112,0Z" opacity="0.2"/><path d="M128,216a7.9,7.9,0,0,1-8-8V192a8,8,0,0,1,16,0v16A7.9,7.9,0,0,1,128,216ZM200,128a72,72,0,0,0-144,0v40a8,8,0,0,0,16,0V128a56,56,0,0,1,112,0v40a8,8,0,0,0,16,0ZM128,184a48,48,0,0,0,48-48V64a48,48,0,0,0-96,0v72A48,48,0,0,0,128,184Zm-40-56a40,40,0,0,1,80,0V64a40,40,0,0,1-80,0Zm-8,88a80.1,80.1,0,0,0,152,0a8,8,0,0,0-16,0a64,64,0,0,1-128,0a8,8,0,0,0-16,0Z"/></svg>
                </button>
                
                <!-- ë‹¤ì‹œ ë“£ê¸° ë²„íŠ¼ (Replay L1 Output) -->
                <button id="replayL1" onclick="replayLastText('L1')" disabled
                        class="replay-btn bg-gray-400 text-white p-4 rounded-full w-20 h-20 flex flex-col items-center justify-center text-xs disabled:bg-gray-400">
                    <!-- Replay Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,40a88.1,88.1,0,0,0-72,142.45L40,168a8,8,0,0,0-13.6,5.66l16,32a8,8,0,0,0,7.6,4.34h.34a8,8,0,0,0,7.26-4.66l16-32A8,8,0,0,0,72,168l-16,14.45A72,72,0,1,1,128,200a8,8,0,0,0,0,16A88,88,0,1,0,128,40Z"/></svg>
                    ë‹¤ì‹œ ë“£ê¸°
                </button>
            </div>
        </div>

        <!-- ìƒëŒ€ë°© ì–¸ì–´ (Their Language) ì„¹ì…˜: L2 -->
        <div id="sectionL2" class="bg-red-50 border-2 border-red-200 rounded-xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 id="titleL2" class="text-xl font-bold text-red-700"></h2>
                <span id="speakerL2" class="text-sm text-red-500 font-semibold"></span>
            </div>
            <div id="outputL2" class="min-h-[6rem] p-3 bg-white rounded-lg border border-red-200 text-gray-700 break-words text-base">
                ë²ˆì—­ëœ ë‚˜ì˜ ì–¸ì–´ ìŒì„± ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
            </div>
            <div class="flex justify-center mt-4 space-x-4">
                <!-- ë§ˆì´í¬ ë²„íŠ¼ -->
                <button id="micL2" onclick="startRecognition('L2')" 
                        class="mic-btn bg-red-500 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center disabled:bg-gray-400">
                    <!-- Mic Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="currentColor" viewBox="0 0 256 256"><path d="M128,176a48,48,0,0,0,48-48V64a48,48,0,0,0-96,0v64A48,48,0,0,0,128,176ZM184,128a56,56,0,0,1-112,0V64a56,56,0,0,1,112,0Z" opacity="0.2"/><path d="M128,216a7.9,7.9,0,0,1-8-8V192a8,8,0,0,1,16,0v16A7.9,7.9,0,0,1,128,216ZM200,128a72,72,0,0,0-144,0v40a8,8,0,0,0,16,0V128a56,56,0,0,1,112,0v40a8,8,0,0,0,16,0ZM128,184a48,48,0,0,0,48-48V64a48,48,0,0,0-96,0v72A48,48,0,0,0,128,184Zm-40-56a40,40,0,0,1,80,0V64a40,40,0,0,1-80,0Zm-8,88a80.1,80.1,0,0,0,152,0a8,8,0,0,0-16,0a64,64,0,0,1-128,0a8,8,0,0,0-16,0Z"/></svg>
                </button>
                
                <!-- ë‹¤ì‹œ ë“£ê¸° ë²„íŠ¼ (Replay L2 Output) -->
                <button id="replayL2" onclick="replayLastText('L2')" disabled
                        class="replay-btn bg-gray-400 text-white p-4 rounded-full w-20 h-20 flex flex-col items-center justify-center text-xs disabled:bg-gray-400">
                    <!-- Replay Icon -->
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M128,40a88.1,88.1,0,0,0-72,142.45L40,168a8,8,0,0,0-13.6,5.66l16,32a8,8,0,0,0,7.6,4.34h.34a8,8,0,0,0,7.26-4.66l16-32A8,8,0,0,0,72,168l-16,14.45A72,72,0,1,1,128,200a8,8,0,0,0,0,16A88,88,0,1,0,128,40Z"/></svg>
                    ë‹¤ì‹œ ë“£ê¸°
                </button>
            </div>
        </div>
        
        <!-- ëŒ€í™” ê¸°ë¡ ì˜ì—­ -->
        <div class="mt-8 pt-4 border-t border-gray-200">
            <h3 class="text-lg font-bold text-gray-700 mb-3">ëŒ€í™” ê¸°ë¡</h3>
            <div id="chatHistory" class="max-h-48 overflow-y-auto p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
                <!-- ëŒ€í™” ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>

    </div>

    <script>
        // ===================================================================
        // 1. ì„¤ì • ë° ìƒíƒœ ë³€ìˆ˜
        // ===================================================================
        const API_KEY = ""; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${API_KEY}`;
        const MODEL = 'gemini-2.5-flash-preview-09-2025';

        let conversationHistory = [];
        let isSpeaking = false;
        let isTranslating = false;
        let activeRecognition = null; // í™œì„± SpeechRecognition ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì €ì¥í•˜ì—¬ ì¤‘ì§€ ìš”ì²­ ì²˜ë¦¬
        
        // ë§ˆì§€ë§‰ ë²ˆì—­ ê²°ê³¼ë¥¼ ì €ì¥í•˜ì—¬ 'ë‹¤ì‹œ ë“£ê¸°' ê¸°ëŠ¥ì— ì‚¬ìš©
        let lastL1Translation = ''; // L2 ì…ë ¥ -> L1 ì¶œë ¥ (ë‚˜ì˜ ì–¸ì–´ ë²ˆì—­ ê²°ê³¼)
        let lastL2Translation = ''; // L1 ì…ë ¥ -> L2 ì¶œë ¥ (ìƒëŒ€ë°© ì–¸ì–´ ë²ˆì—­ ê²°ê³¼)

        // ì–¸ì–´ ì½”ë“œ ë° ì´ë¦„ ë§¤í•‘
        const LANG_MAP = {
            'ko-KR': 'í•œêµ­ì–´ (Korean)',
            'en-US': 'ì˜ì–´ (English)',
            'vi-VN': 'ë² íŠ¸ë‚¨ì–´ (Vietnamese)'
        };

        let selectedL1Code = 'ko-KR'; // ë‚˜ì˜ ì–¸ì–´ (ê¸°ë³¸: í•œêµ­ì–´)
        let selectedL2Code = 'vi-VN'; // ìƒëŒ€ë°© ì–¸ì–´ (ê¸°ë³¸: ë² íŠ¸ë‚¨ì–´)

        const elements = {
            selectL1: document.getElementById('selectL1'),
            selectL2: document.getElementById('selectL2'),
            
            // L1 (ë‚˜ì˜ ì–¸ì–´) ìš”ì†Œ
            titleL1: document.getElementById('titleL1'),
            speakerL1: document.getElementById('speakerL1'),
            outputL1: document.getElementById('outputL1'),
            micL1: document.getElementById('micL1'),
            replayL1: document.getElementById('replayL1'), // ì¶”ê°€
            
            // L2 (ìƒëŒ€ë°© ì–¸ì–´) ìš”ì†Œ
            titleL2: document.getElementById('titleL2'),
            speakerL2: document.getElementById('speakerL2'),
            outputL2: document.getElementById('outputL2'),
            micL2: document.getElementById('micL2'),
            replayL2: document.getElementById('replayL2'), // ì¶”ê°€

            chatHistory: document.getElementById('chatHistory'),
        };
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            console.error('ğŸ”´ ì˜¤ë¥˜: ì´ ë¸Œë¼ìš°ì €ëŠ” Speech Recognitionì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        }

        // ===================================================================
        // 2. UI ë° ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜
        // ===================================================================

        /**
         * ì–¸ì–´ ì„ íƒì— ë”°ë¼ UI í…ìŠ¤íŠ¸ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         */
        function updateUI() {
            const L1_NAME = LANG_MAP[selectedL1Code];
            const L2_NAME = LANG_MAP[selectedL2Code];

            // L1 UI ì—…ë°ì´íŠ¸
            elements.titleL1.textContent = L1_NAME;
            elements.speakerL1.textContent = `ğŸ™ï¸ ${L1_NAME} í™”ì`;
            if(elements.outputL1.textContent.includes('ë²ˆì—­ëœ ìƒëŒ€ë°© ì–¸ì–´')) {
                elements.outputL1.textContent = `${L2_NAME}ë¡œ ë²ˆì—­ëœ ìŒì„± ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.`;
            }

            // L2 UI ì—…ë°ì´íŠ¸
            elements.titleL2.textContent = L2_NAME;
            elements.speakerL2.textContent = `ğŸ™ï¸ ${L2_NAME} í™”ì`;
            if(elements.outputL2.textContent.includes('ë²ˆì—­ëœ ë‚˜ì˜ ì–¸ì–´')) {
                elements.outputL2.textContent = `${L1_NAME}ë¡œ ë²ˆì—­ëœ ìŒì„± ì¶œë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.`;
            }
            
            // ì–¸ì–´ ì„ íƒì´ ê°™ì„ ê²½ìš° ê²½ê³  (ì„ íƒ UIì—ë§Œ ì ìš©)
            if (selectedL1Code === selectedL2Code) {
                 elements.selectL2.classList.add('border-red-500', 'ring-red-500');
                 elements.selectL1.classList.add('border-red-500', 'ring-red-500');
                 updateStatus('âš ï¸ ë‚˜ì˜ ì–¸ì–´ì™€ ìƒëŒ€ë°© ì–¸ì–´ê°€ ê°™ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ì–¸ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                 elements.micL1.disabled = true;
                 elements.micL2.disabled = true;
            } else {
                 elements.selectL2.classList.remove('border-red-500', 'ring-red-500');
                 elements.selectL1.classList.remove('border-red-500', 'ring-red-500');
                 elements.micL1.disabled = false;
                 elements.micL2.disabled = false;
            }
        }

        /**
         * ìƒíƒœ ë©”ì‹œì§€ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. (í™”ë©´ì—ëŠ” í‘œì‹œí•˜ì§€ ì•Šê³  ì½˜ì†”ì—ë§Œ ê¸°ë¡)
         */
        function updateStatus(message, type = 'info') {
            console.log(`[Status - ${type.toUpperCase()}] ${message}`);
        }

        /**
         * ë§ˆì´í¬/ë‹¤ì‹œë“£ê¸° ë²„íŠ¼ì˜ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœì™€ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
         * @param {string|null} listeningSource - í˜„ì¬ ë“£ê³  ìˆëŠ” ë§ˆì´í¬ ('L1' or 'L2') ë˜ëŠ” null (ì¤€ë¹„ ìƒíƒœ)
         */
        function updateMicButtons(listeningSource = null) {
            elements.micL1.classList.remove('listening');
            elements.micL2.classList.remove('listening');
            
            // --- Replay Button Logic ---
            // Replay ë²„íŠ¼ì€ í˜„ì¬ ìŒì„± ì¶œë ¥ì´ ì§„í–‰ ì¤‘ì´ì§€ ì•Šì„ ë•Œ í™œì„±í™”ë©ë‹ˆë‹¤.
            const canReplay = !isSpeaking;

            // L1 Replay: L2 ì…ë ¥ì˜ ë²ˆì—­ ê²°ê³¼(L1 ì–¸ì–´)ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.
            elements.replayL1.disabled = !(canReplay && lastL1Translation);
            elements.replayL1.classList.toggle('bg-green-500', !elements.replayL1.disabled);
            
            // L2 Replay: L1 ì…ë ¥ì˜ ë²ˆì—­ ê²°ê³¼(L2 ì–¸ì–´)ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.
            elements.replayL2.disabled = !(canReplay && lastL2Translation);
            elements.replayL2.classList.toggle('bg-red-500', !elements.replayL2.disabled);

            // ë¹„í™œì„±í™” ì‹œ ê¸°ë³¸ íšŒìƒ‰ ë°°ê²½ ì ìš©
            if (elements.replayL1.disabled) elements.replayL1.classList.remove('bg-green-500');
            if (elements.replayL2.disabled) elements.replayL2.classList.remove('bg-red-500');

            // --- Mic Button Logic ---
            // 0. ì–¸ì–´ ì„ íƒì´ ê°™ê±°ë‚˜ ë²ˆì—­ ì¤‘ì¼ ë•Œ (ë§ˆì´í¬ ë¹„í™œì„±í™”)
            if (selectedL1Code === selectedL2Code || isTranslating) {
                elements.micL1.disabled = true;
                elements.micL2.disabled = true;
                return;
            }

            // 1. ìŒì„± ì¶œë ¥ ì¤‘ì¼ ë•Œ (ë§ˆì´í¬ ë¹„í™œì„±í™”)
            if (isSpeaking) {
                elements.micL1.disabled = true;
                elements.micL2.disabled = true;
                return;
            }

            // 2. ìŒì„± ì¸ì‹ ì¤‘ì¼ ë•Œ (listeningSourceê°€ ì„¤ì •ë˜ì–´ ìˆìŒ)
            if (listeningSource) {
                // í™œì„±í™”ëœ ë§ˆì´í¬ë§Œ í´ë¦­ ê°€ëŠ¥ (ì¤‘ì§€ìš©), ë‹¤ë¥¸ ë§ˆì´í¬ëŠ” ë¹„í™œì„±í™”
                elements.micL1.disabled = (listeningSource !== 'L1');
                elements.micL2.disabled = (listeningSource !== 'L2');
                
                // ì‹œê°ì  ì‹ í˜¸
                if (listeningSource === 'L1') {
                    elements.micL1.classList.add('listening');
                    updateStatus(`ğŸ¤ ${LANG_MAP[selectedL1Code]} ë“£ëŠ” ì¤‘... ë…¹ìŒ í›„ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ë…¹ìŒì„ ë§ˆì¹©ë‹ˆë‹¤.`);
                } else {
                    elements.micL2.classList.add('listening');
                    updateStatus(`ğŸ¤ ${LANG_MAP[selectedL2Code]} ë“£ëŠ” ì¤‘... ë…¹ìŒ í›„ ë²„íŠ¼ì„ ë‹¤ì‹œ í´ë¦­í•˜ì—¬ ë…¹ìŒì„ ë§ˆì¹©ë‹ˆë‹¤.`);
                }
                return;
            }

            // 3. ì¤€ë¹„ ìƒíƒœ (Listeningì´ ëë‚¬ê±°ë‚˜ ì´ˆê¸° ìƒíƒœ) - ëª¨ë‘ í™œì„±í™”
            elements.micL1.disabled = false;
            elements.micL2.disabled = false;
            updateStatus('ì¤€ë¹„ ì™„ë£Œ. ë§ˆì´í¬ ë²„íŠ¼ì„ ëˆŒëŸ¬ í†µì—­ì„ ì‹œì‘í•˜ì„¸ìš”.');
        }

        /**
         * ëŒ€í™” ê¸°ë¡ì„ UIì— ì¶”ê°€í•©ë‹ˆë‹¤.
         */
        function appendToChatHistory(role, languageName, text) {
            const time = new Date().toLocaleTimeString();
            const messageDiv = document.createElement('div');
            
            if (role === 'user') {
                messageDiv.className = 'p-2 bg-blue-100 rounded-lg my-2 ml-auto max-w-[90%] text-right shadow-sm';
                messageDiv.innerHTML = `<span class="text-xs text-blue-800 font-semibold">ë‚˜ (${languageName}, ${time}):</span><br>${text}`;
            } else {
                messageDiv.className = 'p-2 bg-gray-200 rounded-lg my-2 mr-auto max-w-[90%] text-left shadow-sm';
                messageDiv.innerHTML = `<span class="text-xs text-gray-600 font-semibold">Gemini (${languageName}, ${time}):</span><br>${text}`;
            }

            elements.chatHistory.appendChild(messageDiv);
            elements.chatHistory.scrollTop = elements.chatHistory.scrollHeight; // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ ì´ë™
        }
        
        /**
         * ì–¸ì–´ ì„ íƒ ë³€ê²½ í•¸ë“¤ëŸ¬
         */
        function handleLanguageChange() {
            selectedL1Code = elements.selectL1.value;
            selectedL2Code = elements.selectL2.value;
            
            // ì–¸ì–´ ë³€ê²½ ì‹œ ìƒíƒœ ì´ˆê¸°í™”
            conversationHistory = [];
            lastL1Translation = '';
            lastL2Translation = '';
            elements.chatHistory.innerHTML = '';
            
            updateUI();
            updateMicButtons(null);
        }

        // ===================================================================
        // 3. Speech Recognition (STT) - ìŒì„± ì…ë ¥ ì²˜ë¦¬
        // ===================================================================

        function startRecognition(micSource) {
            if (isTranslating || isSpeaking || !SpeechRecognition) return;

            // --- PUSH-TO-STOP ë¡œì§ ---
            if (activeRecognition) {
                // ì´ë¯¸ ë…¹ìŒ ì¤‘ì¼ ë•Œ ê°™ì€ ë§ˆì´í¬ ë²„íŠ¼ì„ í´ë¦­í•˜ë©´ ë…¹ìŒ ì¢…ë£Œ
                activeRecognition.stop(); 
                activeRecognition = null; // stop ìš”ì²­ í›„ ë°”ë¡œ nullë¡œ ì„¤ì •
                return;
            }
            // --------------------------
            
            let sourceLangCode, targetLangCode, sourceName, targetName, sourceOutputElement;

            if (micSource === 'L1') {
                sourceLangCode = selectedL1Code;
                targetLangCode = selectedL2Code;
                sourceOutputElement = elements.outputL1;
            } else { // micSource === 'L2'
                sourceLangCode = selectedL2Code;
                targetLangCode = selectedL1Code;
                sourceOutputElement = elements.outputL2;
            }
            
            sourceName = LANG_MAP[sourceLangCode];
            targetName = LANG_MAP[targetLangCode];

            // ì–¸ì–´ ì„ íƒì´ ê°™ì€ ê²½ìš° ë°©ì§€
            if (sourceLangCode === targetLangCode) return;


            const recognition = new SpeechRecognition();
            activeRecognition = recognition; // í™œì„± ì¸ìŠ¤í„´ìŠ¤ ì €ì¥

            recognition.lang = sourceLangCode;
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            // UI ì—…ë°ì´íŠ¸ - í˜„ì¬ ë§ˆì´í¬ë§Œ í™œì„±í™” (ì¤‘ì§€ í´ë¦­ìš©)
            updateMicButtons(micSource);

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                updateStatus(`ğŸ” ${sourceName} ìŒì„± ì…ë ¥ ì¸ì‹ ì™„ë£Œ. ë²ˆì—­ ì¤‘...`);
                
                // UIì— ì…ë ¥ í…ìŠ¤íŠ¸ í‘œì‹œ
                sourceOutputElement.textContent = transcript;
                
                appendToChatHistory('user', sourceName, transcript);

                // ë²ˆì—­ ë° ìŒì„± ì¶œë ¥ ì‹œì‘ (ì§€ì—° ìµœì†Œí™”)
                translateAndSpeak(transcript, sourceLangCode, targetLangCode, targetName, micSource);
                // onresultê°€ ë°œìƒí•˜ë©´ onendì—ì„œ activeRecognitionì„ nullë¡œ ì„¤ì •í•˜ì§€ ì•ŠìŒ.
                activeRecognition = null; 
            };

            recognition.onerror = (event) => {
                const msg = `ğŸ”´ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}`;
                updateStatus(msg, 'error');
                console.error(msg);
                
                activeRecognition = null; 
                updateMicButtons(null); 
            };

            recognition.onend = () => {
                // onresultì—ì„œ ì´ë¯¸ í†µì—­ì„ ì‹œì‘í–ˆê±°ë‚˜, ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€í–ˆìœ¼ë¯€ë¡œ, 
                // activeRecognitionì´ ë‚¨ì•„ìˆëŠ” ê²½ìš°ëŠ” ë¬´ìŒ ë“±ìœ¼ë¡œ ì¸í•œ ìë™ ì¢…ë£Œ ë¿ì„.
                if (activeRecognition) {
                    activeRecognition = null;
                    updateStatus('âš ï¸ ìŒì„± ì…ë ¥ì´ ì¸ì‹ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'error');
                    updateMicButtons(null); 
                }
            };

            recognition.start();
        }

        // ===================================================================
        // 4. Text-to-Speech (TTS) - ìŒì„± ì¶œë ¥ ì²˜ë¦¬
        // ===================================================================

        // TTSê°€ ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì˜¬ë°”ë¥´ê²Œ ì´ˆê¸°í™”ë˜ë„ë¡ voiceschanged ì´ë²¤íŠ¸ ì‚¬ìš©
        window.speechSynthesis.onvoiceschanged = () => {
             // TTS ëª©ì†Œë¦¬ ëª©ë¡ì´ ë¡œë“œëœ í›„ì—ë„ updateMicButtons í˜¸ì¶œì€ í•„ìš” ì—†ìŒ
        };

        function speakText(text, langCode) {
            if (isSpeaking) {
                window.speechSynthesis.cancel();
            }
            
            isSpeaking = true;
            updateMicButtons(null); // ìŒì„± ì¶œë ¥ ì¤‘ì—ëŠ” ë§ˆì´í¬ ë²„íŠ¼ ë¹„í™œì„±í™”

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = langCode;
            
            const voices = window.speechSynthesis.getVoices();
            // TTS ì–¸ì–´ ì½”ë“œëŠ” ë³´í†µ 'ko-KR'ê³¼ ê°™ì´ ì§€ì—­ ì½”ë“œê¹Œì§€ í¬í•¨ë˜ë¯€ë¡œ startsWith ì‚¬ìš©
            const voice = voices.find(v => v.lang.startsWith(langCode.substring(0, 2))); 
            if (voice) {
                utterance.voice = voice;
            } 

            utterance.onstart = () => {
                updateStatus(`ğŸ”Š ${LANG_MAP[langCode]} ìŒì„± ì¶œë ¥ ì¤‘...`);
            };

            utterance.onend = () => {
                isSpeaking = false;
                // TTS ì™„ë£Œ í›„, ëª¨ë“  ì»¨íŠ¸ë¡¤ í™œì„±í™” (updateMicButtons ë‚´ë¶€ì—ì„œ Replay ë²„íŠ¼ ìƒíƒœë„ ì¬ê³„ì‚°ë¨)
                updateMicButtons(null); 
            };

            utterance.onerror = (event) => {
                const msg = `ğŸ”´ ìŒì„± ì¶œë ¥ ì˜¤ë¥˜: ${event.error}`;
                updateStatus(msg, 'error');
                console.error(msg);
                isSpeaking = false;
                updateMicButtons(null); 
            };

            window.speechSynthesis.speak(utterance);
        }
        
        /**
         * 'ë‹¤ì‹œ ë“£ê¸°' ë²„íŠ¼ í´ë¦­ ì‹œ ë§ˆì§€ë§‰ ë²ˆì—­ëœ í…ìŠ¤íŠ¸ë¥¼ ì¬ìƒí•©ë‹ˆë‹¤.
         * @param {string} side - 'L1' (ë‚˜ì˜ ì–¸ì–´ ì¶œë ¥) ë˜ëŠ” 'L2' (ìƒëŒ€ë°© ì–¸ì–´ ì¶œë ¥)
         */
        function replayLastText(side) {
            if (isTranslating || isSpeaking) return;

            let textToSpeak = '';
            let langCode = '';

            if (side === 'L1') { // L1 Output (ë‚˜ì˜ ì–¸ì–´ë¡œ ë²ˆì—­ëœ í…ìŠ¤íŠ¸)
                textToSpeak = lastL1Translation;
                langCode = selectedL1Code;
            } else { // L2 Output (ìƒëŒ€ë°© ì–¸ì–´ë¡œ ë²ˆì—­ëœ í…ìŠ¤íŠ¸)
                textToSpeak = lastL2Translation;
                langCode = selectedL2Code;
            }

            if (textToSpeak) {
                updateStatus(`ğŸ”„ ${LANG_MAP[langCode]} ì´ì „ í…ìŠ¤íŠ¸ ë‹¤ì‹œ ë“£ê¸° ìš”ì²­`);
                speakText(textToSpeak, langCode);
            } else {
                updateStatus('âš ï¸ ë‹¤ì‹œ ë“¤ì„ í…ìŠ¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € í†µì—­ì„ ì‹œë„í•´ ì£¼ì„¸ìš”.', 'warning');
            }
        }


        // ===================================================================
        // 5. Gemini API ë²ˆì—­ ë° ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬ (ìµœëŒ€ ì†ë„ ìœ ì§€)
        // ===================================================================

        /**
         * ì§€ìˆ˜ ë°±ì˜¤í”„ë¥¼ ì‚¬ìš©í•˜ì—¬ API í˜¸ì¶œì„ ì‹œë„í•©ë‹ˆë‹¤.
         */
        async function withExponentialBackoff(fn, maxRetries = 3) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await fn();
                } catch (error) {
                    if (i === maxRetries - 1) {
                        throw error;
                    }
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function translateAndSpeak(text_to_translate, sourceLangCode, targetLangCode, targetName, micSource) {
            if (isTranslating) return;

            isTranslating = true;
            updateStatus(`âœ¨ ${targetName}ë¡œ ì „ë¬¸ê°€ ë²ˆì—­ ì¤‘...`);
            
            // ë²ˆì—­ ì¤‘ì—ëŠ” ëª¨ë“  ë§ˆì´í¬ ë²„íŠ¼ ë¹„í™œì„±í™”
            updateMicButtons(null); 
            
            const sourceName = LANG_MAP[sourceLangCode];
            const targetOutputElement = micSource === 'L1' ? elements.outputL2 : elements.outputL1;

            // 1. ì‹œìŠ¤í…œ ì§€ì¹¨ ì„¤ì •
            const systemPrompt = `You are a professional ${sourceName} to ${targetName} simultaneous interpreter. Translate the user's input into natural, contextually appropriate, and polite ${targetName}. Only output the translated text. Do not include any extra commentary or formatting.`;

            // 2. ëŒ€í™” ê¸°ë¡ì— ì‚¬ìš©ì ì…ë ¥ ì¶”ê°€
            const userPart = { role: "user", parts: [{ text: text_to_translate }] };
            conversationHistory.push(userPart);

            // 3. API Payload êµ¬ì„±: ì†ë„ ìµœì í™”ë¥¼ ìœ„í•´ ìµœê·¼ 4ê°œ í„´(2ìŒì˜ ëŒ€í™” + í˜„ì¬ ë°œí™”)ë§Œ ì „ì†¡
            const contentsForApi = conversationHistory.slice(-4); 

            const payload = {
                contents: contentsForApi, 
                systemInstruction: { parts: [{ text: systemPrompt }] },
                config: { temperature: 0.2 }, 
            };
            
            try {
                const fetcher = async () => {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}. Body: ${errorBody}`);
                    }
                    return response.json();
                };

                const result = await withExponentialBackoff(fetcher);
                const translatedText = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "ë²ˆì—­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.";

                // 4. ë²ˆì—­ ê²°ê³¼ ì €ì¥
                if (micSource === 'L1') {
                    lastL2Translation = translatedText; // L1 ì…ë ¥ -> L2 ì¶œë ¥
                } else {
                    lastL1Translation = translatedText; // L2 ì…ë ¥ -> L1 ì¶œë ¥
                }

                // 5. UI ì—…ë°ì´íŠ¸
                targetOutputElement.textContent = translatedText;

                // 6. ëŒ€í™” ê¸°ë¡ì— ëª¨ë¸ ì‘ë‹µ ì¶”ê°€
                const modelPart = { role: "model", parts: [{ text: translatedText }] };
                conversationHistory.push(modelPart);
                appendToChatHistory('model', targetName, translatedText);
                
                // 7. ìŒì„± ì¶œë ¥ (ì§€ì—° ì—†ì´ ì¦‰ì‹œ ì‹œì‘)
                speakText(translatedText, targetLangCode);

            } catch (e) {
                console.error("Gemini API Error:", e);
                const errorMsg = `ğŸ”´ ë²ˆì—­ ì‹¤íŒ¨: API í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ìì„¸í•œ ë‚´ìš©ì€ ì½˜ì†” í™•ì¸)`;
                updateStatus(errorMsg, 'error');
                
                // ì˜¤ë¥˜ ë°œìƒ ì‹œ ë§ˆì´í¬ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                updateMicButtons(null);
            } finally {
                isTranslating = false;
            }
        }

        // ===================================================================
        // 6. ì´ˆê¸°í™” ë° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        // ===================================================================

        window.onload = () => {
            // ì´ˆê¸° UI ì„¤ì •
            updateUI(); 

            if (SpeechRecognition) {
                // ì´ˆê¸° ìƒíƒœ: ì–‘ìª½ ë§ˆì´í¬ ë° ë‹¤ì‹œë“£ê¸° ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                updateMicButtons(null); 
            }
            
            // ì–¸ì–´ ì„ íƒ ë³€ê²½ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            elements.selectL1.addEventListener('change', handleLanguageChange);
            elements.selectL2.addEventListener('change', handleLanguageChange);
        };
    </script>
</body>
</html>
